---
phase: 01-fix-ui-freeze
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - ScreenSort/ViewModels/ProcessingViewModel.swift
  - ScreenSort/Views/ProcessingView.swift
autonomous: false

must_haves:
  truths:
    - "User can scroll results list while processing runs"
    - "User can tap cancel and processing stops within 2 seconds"
    - "User sees immediate feedback when processing starts (no freeze)"
    - "Unknown screenshots remain in original album (not moved)"
    - "Only classified screenshots are moved to destination albums"
  artifacts:
    - path: "ScreenSort/ViewModels/ProcessingViewModel.swift"
      provides: "Non-blocking processing with cancellation support"
      contains: "processingTask"
    - path: "ScreenSort/Views/ProcessingView.swift"
      provides: "Cancel button during processing"
      contains: "cancelProcessing"
  key_links:
    - from: "ProcessingView cancel button"
      to: "ProcessingViewModel.cancelProcessing()"
      via: "Button action"
      pattern: "viewModel\\.cancelProcessing"
    - from: "ProcessingViewModel.processNow()"
      to: "Task.isCancelled"
      via: "Cancellation check in loop"
      pattern: "Task\\.isCancelled"
    - from: "ProcessingViewModel.processUnknownScreenshot()"
      to: "No album move"
      via: "Removed addAsset call"
      pattern: "processUnknownScreenshot.*->.*ProcessingResultItem"
---

<objective>
Make ProcessingViewModel run heavy work off the main thread using nonisolated functions, add cancellation support with stored Task reference, fix unknown screenshot handling to NOT move them to albums, and add cancel button to ProcessingView.

Purpose: The ViewModel's @MainActor isolation causes all async work to run on main thread. This plan extracts heavy work to nonisolated functions, adds user-triggered cancellation, and ensures unknown screenshots stay in their original location per requirements ORG-01/ORG-02.

Output: Non-blocking ProcessingViewModel with cancellation + Cancel button UI + Correct unknown screenshot handling.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-fix-ui-freeze/01-RESEARCH.md
@.planning/phases/01-fix-ui-freeze/01-01-SUMMARY.md

# Source files to modify
@ScreenSort/ViewModels/ProcessingViewModel.swift
@ScreenSort/Views/ProcessingView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cancellation support to ProcessingViewModel</name>
  <files>ScreenSort/ViewModels/ProcessingViewModel.swift</files>
  <action>
Modify ProcessingViewModel.swift to support cancellation:

1. Add a stored Task property after line 20 (after `googleDocsError`):
```swift
private var processingTask: Task<Void, Never>?
```

2. Add a public `cancelProcessing()` method after `signOutYouTube()` (around line 158):
```swift
func cancelProcessing() {
    processingTask?.cancel()
}
```

3. Refactor `processNow()` (lines 161-241) to:
   - Wrap the processing loop in a Task and store the reference
   - Check `Task.isCancelled` at the START of each iteration (before expensive work)
   - Clean up `processingTask = nil` in defer block (after isIdleTimerDisabled reset)

The refactored structure should look like:
```swift
func processNow() async {
    guard hasPhotoAccess else { ... }
    guard isYouTubeAuthenticated else { ... }

    isProcessing = true
    results = []
    ocrSnapshots = [:]
    lastError = nil
    UIApplication.shared.isIdleTimerDisabled = true

    defer {
        UIApplication.shared.isIdleTimerDisabled = false
        processingTask = nil
        isProcessing = false
        print("...")
    }

    do {
        // Fetch screenshots, create playlist, create albums (existing code)
        let screenshots = ...
        let playlistId = ...

        processingTask = Task {
            for (index, asset) in screenshots.enumerated() {
                // Check cancellation BEFORE expensive work
                guard !Task.isCancelled else {
                    print("Processing cancelled at item \(index)")
                    break
                }

                processingProgress = (index + 1, screenshots.count)
                let result = await processScreenshot(asset: asset, playlistId: playlistId)
                results.append(result)
                print("...")
            }
        }

        await processingTask?.value
        googleDocURL = googleDocsService.documentURL

    } catch {
        lastError = error.localizedDescription
    }
}
```

Important: Move `isProcessing = false` into the defer block so it runs even if cancelled.
  </action>
  <verify>
Build with `xcodebuild -project ScreenSort.xcodeproj -scheme ScreenSort -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -20` - should compile.
  </verify>
  <done>
ProcessingViewModel has `processingTask` property, `cancelProcessing()` method, and `processNow()` checks `Task.isCancelled` in the loop.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix unknown screenshot handling (ORG-01/ORG-02)</name>
  <files>ScreenSort/ViewModels/ProcessingViewModel.swift</files>
  <action>
Fix ProcessingViewModel.swift so unknown/unclassifiable screenshots are NOT moved to any album:

1. Modify `processUnknownScreenshot(asset:)` (lines 447-474):
   - REMOVE the `try await photoService.addAsset(asset, toAlbum: ScreenshotType.unknown.albumName)` call
   - Keep the caption setting
   - Keep the return statement
   - Remove the do/catch since we no longer have a throwing call

The method should become:
```swift
private func processUnknownScreenshot(asset: PHAsset) async -> ProcessingResultItem {
    // Do NOT move to any album - leave in original location (ORG-01)
    let caption = buildCaption(type: "Unknown", title: nil, creator: nil, status: "Could not classify")
    try? await photoService.setCaption(caption, for: asset)

    return ProcessingResultItem(
        assetId: asset.localIdentifier,
        status: .flagged,
        contentType: .unknown,
        title: nil,
        creator: nil,
        message: "Could not classify screenshot",
        serviceLink: nil
    )
}
```

2. Modify `handleExtractionError(asset:contentType:error:)` (lines 478-501):
   - REMOVE the `try? await photoService.addAsset(asset, toAlbum: ScreenshotType.unknown.albumName)` call
   - Keep the caption and return statement

3. Modify `handleProcessingError(asset:error:)` (lines 504-519):
   - REMOVE the `try? await photoService.addAsset(asset, toAlbum: ScreenshotType.unknown.albumName)` call
   - Keep the caption and return statement

This ensures: Only successfully classified screenshots (music, movie, book, meme) are moved to albums. Unknown/failed screenshots stay in their original location.
  </action>
  <verify>
Build with `xcodebuild -project ScreenSort.xcodeproj -scheme ScreenSort -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -20` - should compile.
Grep to confirm no addAsset calls in unknown/error handlers: `grep -n "addAsset.*unknown" ScreenSort/ViewModels/ProcessingViewModel.swift` should return nothing.
  </verify>
  <done>
`processUnknownScreenshot`, `handleExtractionError`, and `handleProcessingError` no longer call `addAsset` to move screenshots to any album. Unknown screenshots stay in place.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add cancel button to ProcessingView</name>
  <files>ScreenSort/Views/ProcessingView.swift</files>
  <action>
Add a cancel button to ProcessingView.swift that appears when processing is active:

Modify the `processingSection` computed property (around lines 240-292) to add a cancel button below the progress text:

Inside the `GlassCard` VStack, after the existing content (the "X of Y screenshots" text), add:
```swift
// Cancel button
Button(action: {
    viewModel.cancelProcessing()
}) {
    HStack(spacing: 6) {
        Image(systemName: "xmark.circle.fill")
            .font(.subheadline)
        Text("Cancel")
            .font(.subheadline.weight(.medium))
    }
    .foregroundStyle(.red)
    .padding(.horizontal, 16)
    .padding(.vertical, 8)
    .background(Color.red.opacity(0.1))
    .clipShape(Capsule())
}
.buttonStyle(.plain)
.padding(.top, AppTheme.spacingSM)
```

The cancel button should:
- Use red color with subtle red background
- Be capsule-shaped
- Call `viewModel.cancelProcessing()` when tapped
- Only appear when `viewModel.isProcessing` is true (already handled by parent conditional)
  </action>
  <verify>
Build with `xcodebuild -project ScreenSort.xcodeproj -scheme ScreenSort -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -20` - should compile.
Grep to confirm cancel button exists: `grep -n "cancelProcessing" ScreenSort/Views/ProcessingView.swift` should find the button action.
  </verify>
  <done>
ProcessingView has a Cancel button in the processing section that calls `viewModel.cancelProcessing()`.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Non-blocking processing with cancellation support and correct unknown screenshot handling:
1. OCRService runs Vision on background thread
2. ProcessingViewModel supports cancel via stored Task
3. Unknown screenshots stay in original album (not moved)
4. Cancel button appears during processing
  </what-built>
  <how-to-verify>
1. Build and run the app on simulator or device
2. Grant photo and Google permissions
3. Start processing with "Process Screenshots" button
4. Verify: UI is responsive - you can scroll the results list while processing
5. Verify: Cancel button appears during processing
6. Tap Cancel - processing should stop within 2 seconds
7. Check Photos app - unknown/unclassified screenshots should NOT be in "ScreenSort - Flagged" album
8. Verify: Successfully classified screenshots ARE in their respective albums (Music, Movies, etc.)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Project builds without errors
2. `processingTask` property exists in ProcessingViewModel
3. `cancelProcessing()` method exists and is called from UI
4. `Task.isCancelled` is checked at start of processing loop
5. No `addAsset` calls for unknown screenshots
6. Cancel button visible during processing
7. UI remains responsive during processing (no freeze)
</verification>

<success_criteria>
- User can scroll results while processing (PROC-04)
- Cancel button stops processing within 2 seconds (PROC-03)
- No UI freeze when processing starts (PROC-01)
- Unknown screenshots stay in original album (ORG-01)
- Only classified screenshots move to albums (ORG-02)
</success_criteria>

<output>
After completion, create `.planning/phases/01-fix-ui-freeze/01-02-SUMMARY.md`
</output>
