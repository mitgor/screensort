---
phase: 04-launch-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ScreenSort/ViewModels/ProcessingViewModel.swift
  - ScreenSort/Views/ProcessingView.swift
autonomous: true

must_haves:
  truths:
    - "User sees placeholder rows with shimmer while background refresh happens"
    - "Skeleton UI matches layout of real result rows (no jarring layout shift)"
    - "Skeleton is skipped when cached data loads immediately (no flicker)"
  artifacts:
    - path: "ScreenSort/ViewModels/ProcessingViewModel.swift"
      provides: "isRefreshing state flag for skeleton display"
      contains: "isRefreshing"
    - path: "ScreenSort/Views/ProcessingView.swift"
      provides: "Conditional redacted modifier on results section"
      contains: ".redacted"
  key_links:
    - from: "ProcessingView.swift"
      to: "ProcessingViewModel.isRefreshing"
      via: "Conditional redaction based on state"
      pattern: "viewModel\\.isRefreshing"
---

<objective>
Add skeleton loading UI with shimmer animation for the results section during background refresh.

Purpose: LAUNCH-02 requires users see skeleton/placeholder UI while fresh data loads in background. This provides visual feedback during background operations without jarring flicker when cached data is available.

Output: Results section shows shimmer placeholders during refresh, skips skeleton when cached data loads instantly.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-launch-experience/04-RESEARCH.md

@ScreenSort/ViewModels/ProcessingViewModel.swift
@ScreenSort/Views/ProcessingView.swift
@ScreenSort/Design/DesignSystem.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add placeholder data generator and refreshing state</name>
  <files>ScreenSort/ViewModels/ProcessingViewModel.swift</files>
  <action>
1. Add `isRefreshing` observable state property (Bool, default false) to ProcessingViewModel.

2. Add static placeholder generator to ProcessingResultItem:
```swift
extension ProcessingResultItem {
    static func placeholder(index: Int) -> ProcessingResultItem {
        ProcessingResultItem(
            assetId: "placeholder-\(index)",
            status: .success,
            contentType: .music,
            title: String(repeating: "X", count: 18),
            creator: String(repeating: "X", count: 12),
            message: "Loading...",
            serviceLink: nil
        )
    }

    static var placeholders: [ProcessingResultItem] {
        (0..<5).map { ProcessingResultItem.placeholder(index: $0) }
    }
}
```

3. In checkInitialState(), after loading cached results, if results are NOT empty, do NOT set isRefreshing (skip skeleton for cached data per research).

4. Only set isRefreshing = true when starting a background refresh AND results.isEmpty.

Note: The existing checkInitialState() loads cached data synchronously which is correct. Do not change this synchronous behavior - it ensures cached data appears instantly.
  </action>
  <verify>Build succeeds with `xcodebuild -scheme ScreenSort -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -20`</verify>
  <done>ProcessingResultItem.placeholders returns 5 placeholder items, isRefreshing property exists on ViewModel</done>
</task>

<task type="auto">
  <name>Task 2: Apply skeleton UI with redacted modifier and shimmer</name>
  <files>ScreenSort/Views/ProcessingView.swift</files>
  <action>
1. In resultsSection, modify the LazyVStack content to use placeholders when showing skeleton:
```swift
// Replace the ForEach in resultsSection's GlassCard
ForEach(viewModel.isRefreshing && viewModel.successResults.isEmpty
        ? ProcessingResultItem.placeholders
        : viewModel.successResults) { result in
    CompactResultRow(result: result)
    Divider()
        .padding(.horizontal, AppTheme.spacingSM)
}
```

2. Apply conditional redaction and shimmer to the GlassCard containing results:
```swift
GlassCard(padding: AppTheme.spacingSM) {
    // ... existing ScrollView content
}
.redacted(reason: viewModel.isRefreshing && viewModel.successResults.isEmpty ? .placeholder : [])
.shimmer()  // ShimmerModifier only animates when redacted
```

3. The existing ShimmerModifier in DesignSystem.swift works with redacted views - the gradient overlay creates the shimmer effect. No changes needed to DesignSystem.swift.

4. Important: Do NOT show skeleton if results are non-empty. The condition `viewModel.isRefreshing && viewModel.successResults.isEmpty` ensures we only skeleton when truly loading from scratch.
  </action>
  <verify>Build succeeds with `xcodebuild -scheme ScreenSort -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -20`</verify>
  <done>Results section shows placeholder rows with shimmer when isRefreshing is true and results are empty; shows real results otherwise</done>
</task>

</tasks>

<verification>
1. Build succeeds without errors
2. When app launches with cached results, results appear immediately (no skeleton flash)
3. Code inspection confirms:
   - isRefreshing state exists in ViewModel
   - ProcessingResultItem.placeholders generates 5 placeholder items
   - resultsSection uses conditional redaction
   - Skeleton only shows when isRefreshing AND results are empty
</verification>

<success_criteria>
- ProcessingResultItem has static placeholder generator
- ProcessingViewModel has isRefreshing state
- Results section applies .redacted() + .shimmer() conditionally
- Skeleton is skipped when cached data exists (no flicker)
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-launch-experience/04-01-SUMMARY.md`
</output>
